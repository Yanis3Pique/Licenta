@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model IEnumerable<Licenta_v1.Models.Delivery>

@{
    ViewData["Title"] = "Deliveries";
}

<h2 class="text-center">Deliveries</h2>
<br />

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<!-- Search, Sort & Filter -->
<div class="card shadow-sm p-3 mb-4" id="light-blue-elements-background-id">
    <form asp-action="Index" method="get">
        <div class="row g-2 align-items-end">
            <!-- Search -->
            <div class="col-12 col-md-3 d-flex flex-column">
                <label for="searchString" class="form-label">Search</label>
                <input type="text" id="searchString" name="searchString" class="form-control" placeholder="Driver, Vehicle" value="@ViewBag.SearchString" />
            </div>

            <!-- Filter by Planned Start Date -->
            <div class="col-12 col-md-2 d-flex flex-column">
                <label for="plannedStartDate" class="form-label">Planned</label>
                <input type="date" id="plannedStartDate" name="plannedStartDate" class="form-control" value="@ViewBag.PlannedStartDate" />
            </div>

            <!-- Filter by Delivered Date -->
            <div class="col-12 col-md-2 d-flex flex-column">
                <label for="actualEndDate" class="form-label">Delivered</label>
                <input type="date" id="actualEndDate" name="actualEndDate" class="form-control" value="@ViewBag.ActualEndDate" />
            </div>

            <!-- Filter by Region -->
            <div class="col-12 col-md-2 d-flex flex-column">
                <label for="regionId" class="form-label">Region</label>
                @Html.DropDownList("regionId", ViewBag.Regions as SelectList, "All Regions", new { @class = "form-select" })
            </div>

            <!-- Filter by Status -->
            <div class="col-12 col-md-2 d-flex flex-column">
                <label for="status" class="form-label">Status</label>
                <select id="status" name="status" class="form-select">
                    <option value="Planned" selected="@(ViewBag.Status == "Planned" ? "selected" : "")">Planned</option>
                    <option value="In Progress" selected="@(ViewBag.Status == "In Progress" ? "selected" : "")">In Progress</option>
                    <option value="Completed" selected="@(ViewBag.Status == "Completed" ? "selected" : "")">Completed</option>
                    <option value="Up for Taking" selected="@(ViewBag.Status == "Up for Taking" ? "selected" : "")">Up for Taking</option>
                    <option value="All" selected="@(ViewBag.Status == "All" ? "selected" : "")">All Statuses</option>
                </select>
            </div>

            <!-- Submit -->
            <div class="col-12 col-md-1 d-grid align-self-end">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>
</div>

<!-- Optimizare Deliveries -->
<div class="text-center mb-4">
    @if (User.IsInRole("Admin"))
    {
        <a asp-action="OptimizeAll" class="btn btn-primary me-2">
            Optimize All
        </a>
        <form asp-action="CleanupDeliveries" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete the Deliveries?');">
            <button type="submit" class="btn btn-danger">
                Delete All Deliveries
            </button>
        </form>
    }
    @if (User.IsInRole("Dispecer"))
    {
        <a asp-action="OptimizeRegion" class="btn btn-secondary">Optimize My Region</a>
        <a asp-action="Create" class="btn btn-info">Create Delivery</a>
    }
</div>

@if (!Model.Any())
{
    <div class="alert alert-info text-center">No deliveries found.</div>
}
else
{
    <!-- Pt ecrane mari -->
    <div class="d-none d-md-block table-responsive">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th id="light-blue-elements-background-id">Driver</th>
                    <th id="light-blue-elements-background-id">Vehicle</th>
                    <th id="light-blue-elements-background-id">Region</th>
                    <th id="light-blue-elements-background-id">Planned Start</th>
                    <th id="light-blue-elements-background-id">Delivered Date</th>
                    <th id="light-blue-elements-background-id">Status</th>
                    <th id="light-blue-elements-background-id"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td id="light-blue-elements-background-id">
                            <a asp-controller="Users" asp-action="Show" asp-route-id="@item.Driver?.Id">@item.Driver?.UserName</a>
                        </td>
                        <td id="light-blue-elements-background-id">@item.Vehicle?.Brand @item.Vehicle?.Model (@item.Vehicle?.RegistrationNumber)</td>
                        <td id="light-blue-elements-background-id">@(item.Orders.Any() ? item.Orders.First().Region?.County : "N/A")</td>
                        <td id="light-blue-elements-background-id">@item.PlannedStartDate.ToString("d")</td>
                        <td id="light-blue-elements-background-id">@(item.ActualEndDate != null ? item.ActualEndDate.Value.ToString("d") : "N/A")</td>
                        <td id="light-blue-elements-background-id">@item.Status</td>
                        <td id="light-blue-elements-background-id">
                            <a asp-action="Show" asp-route-id="@item.Id" class="btn btn-info">Details</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!-- Pt ecrane mici -->
<div class="d-block d-md-none">
    @foreach (var item in Model)
    {
        <div class="card mb-3 shadow-sm text-center" id="light-blue-elements-background-id">
            <div class="card-body">
                <h5 class="card-title">Delivery - @item.Id</h5>
                <p class="card-text">
                    <strong>Driver:</strong>
                    <a asp-controller="Users" asp-action="Show" asp-route-id="@item.Driver?.Id">@item.Driver?.UserName</a> <br />
                    <strong>Vehicle:</strong> @item.Vehicle?.Brand @item.Vehicle?.Model (@item.Vehicle?.RegistrationNumber) <br />
                    <strong>Region:</strong> @(item.Orders.Any() ? item.Orders.First().Region?.County : "N/A") <br />
                    <strong>Planned Start:</strong> @item.PlannedStartDate.ToString("d") <br />
                    <strong>Delivered Date:</strong> @(item.ActualEndDate != null ? item.ActualEndDate.Value.ToString("d") : "N/A") <br />
                    <strong>Status:</strong> @item.Status
                </p>
                <a asp-action="Show" asp-route-id="@item.Id" class="btn btn-primary btn-sm">View Details</a>
            </div>
        </div>
    }
</div>