@model IEnumerable<Licenta_v1.Models.ApplicationUser>
@inject Microsoft.AspNetCore.Identity.UserManager<Licenta_v1.Models.ApplicationUser> UserManager
@{
    ViewBag.Title = "Dispatchers";
}

<h2 class="text-center">@ViewBag.Title</h2>
<br />

<div class="card shadow-sm p-3 mb-4">
    <form method="get">
        <div class="row g-2 align-items-center">
            <!-- Bara de cautare -->
            <div class="col-md-4 col-sm-6">
                <input type="text" name="searchString" class="form-control" placeholder="Search users" value="@ViewBag.SearchString" />
            </div>

            <!-- Filtrare dupa regiuni -->
            <div class="col-md-3 col-sm-6">
                @Html.DropDownList("regionId",
                         ViewBag.Regions as SelectList,
                         "All Regions",
                         new { @class = "form-select" })
            </div>

            <!-- Sortare dupa nume sau vechime in firma -->
            <div class="col-md-3 col-sm-6">
                <form method="get">
                    <select class="form-select" name="sortOrder">
                        <option value="name" selected="@(ViewBag.CurrentSort == "name" ? "selected" : "")">Name (Ascending)</option>
                        <option value="name_desc" selected="@(ViewBag.CurrentSort == "name_desc" ? "selected" : "")">Name (Descending)</option>
                        <option value="date" selected="@(ViewBag.CurrentSort == "date" ? "selected" : "")">Date Hired (Ascending)</option>
                        <option value="date_desc" selected="@(ViewBag.CurrentSort == "date_desc" ? "selected" : "")">Date Hired (Descending)</option>
                        <option value="" selected="@(string.IsNullOrEmpty(ViewBag.CurrentSort) ? "selected" : "")">Sort by</option>
                    </select>
                </form>
            </div>

            <!-- Buton de submit pt tot -->
            <div class="col-md-2 col-sm-6">
                <button type="submit" class="btn btn-primary w-100">Apply</button>
            </div>
        </div>
    </form>
</div>

<!-- Carduri cu useri -->
<div class="row row-cols-1 row-cols-md-3 g-4">
    @foreach (var user in Model)
    {
        <div class="col">
            <div class="card h-100 text-center">
                <img src="@(Url.Content("~/" + (user.PhotoPath ?? "Images/Default.jpg")))"
                     class="card-img-top img-fluid"
                     alt="User Photo"
                     style="height: auto; max-height: 300px; object-fit: cover;">

                <div class="card-body">
                    <h4 class="card-title">@Html.DisplayFor(modelItem => user.FirstName) @Html.DisplayFor(modelItem => user.LastName)</h4>
                    <p class="card-text">
                        <strong>User Name:</strong> @Html.DisplayFor(modelItem => user.UserName)<br />
                        <strong>Region:</strong> @(user.Region?.County ?? "N/A")<br />
                        <strong>Date Hired:</strong> @(user.DateHired.ToShortDateString() ?? "N/A")
                    </p>
                </div>

                <div class="card-footer">
                    <div class="d-flex justify-content-center align-items-center">
                        @Html.ActionLink("Details", "Show", new { id = user.Id }, new { @class = "btn btn-info btn-sm mb-2 mx-2" })
                        @if (User.IsInRole("Admin") || User.IsInRole("Dispecer"))
                        {
                            var userRoles = await UserManager.GetRolesAsync(user);
                            if (userRoles.Contains("Dispecer"))
                            {
                                <a href="@Url.Action("ShowDriversOfDispatcher", "Users", new { id = user.Id })" class="btn btn-info btn-sm mb-2 mx-2">
                                    Show Drivers
                                </a>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Paginarea userilor -->
<nav>
    <ul class="pagination justify-content-center">
        @{
            int totalPages = ViewBag.TotalPages;
            int pageNumber = ViewBag.PageNumber;
            string query = $"&searchString={ViewBag.SearchString}&regionId={ViewBag.RegionId}&sortOrder={ViewBag.CurrentSort}";
        }

        <li class="page-item @(pageNumber == 1 ? "disabled" : "")">
            <a class="page-link" href="?pageNumber=@(pageNumber - 1)@query">Previous</a>
        </li>

        @for (int i = 1; i <= totalPages; i++)
        {
            <li class="page-item @(i == pageNumber ? "active" : "")">
                <a class="page-link" href="?pageNumber=@i@query">@i</a>
            </li>
        }

        <li class="page-item @(pageNumber == totalPages ? "disabled" : "")">
            <a class="page-link" href="?pageNumber=@(pageNumber + 1)@query">Next</a>
        </li>
    </ul>
</nav>
